# 서비스: 클라이언트가 파드를 검색하고 통신을 가능하게 함

5장에서 다루는 내용
- 단일 주소로 파드를 노출하는 서비스 리소스 만들기
- 클러스터 안에서 서비스 검색
- 외부 클라이언트에 서비스 노출
- 클러스터 내에서 외부 서비스 접속
- 파드가 서비스할 준비가 됐는지 제어하는 방법
- 서비스 문제 해결

특정 파드는 외부 요청 없이 독립적으로 작업을 수행할 수 있지만 대다수의 애플리케이션은 외부 요청에 응답하기 위한 것이다. 마이크로서비스의 경우 파드는 대개 클러스터 내부의 다른 파드나 클러스터 외부의 클라이언트에서 오는 HTTP 요청에 응답한다.<br><br>
파드가 다른 파드에게 제공하는 서비스를 사용하려면 파드를 찾는 방법이 필요하다.

- 파드는 일시적이다.
- 파드의 IP주소를 미리 알 수 없다.
- 파드는 단일 IP 주소로 액세스할 수 있어야 한다.

쿠버네티스는 이런 문제를 해결하기 위해 서비스(Service)를 제공 한다.

## 서비스 소개
각 서비스는 서비스가 존재하는 동안 절대 바뀌지 않는 IP 주소와 포트가 있다. 클라이언트는 해당 IP와 포트로 접속한 다음 해당 서비스를 지원하는 파드 중 하나로 연결된다.

### 서비스 생성
- kubectl expose로 서비스 생성
- YAML 디스크립터를 통한 서비스 생성
- 새 서비스 검사하기 : kubectl get svc
- 실행 중인 컨테이너에 원격으로 명령어 실행 : kubectl exec kubia -- curl -s ~~~

>> 더블 대시(--)는 kubectl 명령줄 옵션의 끝을 의미한다. 더블 대시 뒤의 모든 거은 파드 내에서 실행돼야 하는 명령어다.

<br>

**서비스의 세션 어피니티 구성**<br>
동일한 명령을 몇 번 실행하면 동일한 클라이언트에서 요청 하더라도 서비스 프록시가 각 연결을 임의의 파드를 선택해 연결을 다시 전달 한다. sessionAffinity: ClientIP 값을 설정 하면 특정 클라이언트의 요청을 매번 같은 파드로 리디렉션 시킬 수 있다.

<br>

**동일한 서비스에서 여러 개의 포트 노출**<br>
서비스는 여러 포트를 지원할 수도 있다.

<br>

**이름이 지정된 포트 사용**<br>
컨테이너 포트에 이름을 지정 해서 서비스에서 포트 이름으로 사용 할 수 있다.

### 서비스 검색
- 환경변수를 통한 서비스 검색
- DNS를 통한 서비스 검색

## 클러스터 외부에 있는 서비스 연결

### 서비스 엔드포인트 소개
서비스는 파드에 직접 연결되지 않는다. 대신 엔드포인트 리소스가 그 사이에 있다.
```
kubectl describe svc kubia // 이 명령어로 엔드포인트를 확인할 수 있다.

kubectl get endpoint kubia // 엔드포인트 리소스는 서비스로 노출되는 파드의 IP 주소와 포트 목록이다.
```

### 서비스 엔드포인트 수동 구성
셀렉터 없이 서비스를 생성한 후 서비스와 이름이 같은 엔드포인트 오브젝트를 만들어야 한다. 또한 서비스를 제공하는 대상 IP주소와 포트 목록을 가져야 한다.

### 외부 서비스를 위한 별칭 생성
서비스의 엔드포인트를 수동으로 구성해 외부 서비스를 노출하는 대신 좀 더 간단한 방법으로 FQDN(정규화된 도메인 이름)으로 외부 서비스를 참조할 수 있다.

## 외부 클라이언트에 서비스 노출
외부에서 서비스를 액세스할 수 있는 몇 가지 방법이 있다.
- 노드포트로 서비스 유형 설정
- 서비스 유형을 노드포트 유형의 확장인 로드밸런서로 설정
- 단일 IP 주소로 여러 서비스를 노출하는 인그레스 리소스 만들기

### 노드포트 서비스 사용
```YAML
apiVersion: v1
kind: Service
metadata:
    name: kubia-nodeport
spec:
    type: NodePort #서비스 유형을 노드포트로 설정
    ports:
    - port: 80
      targetPort: 8080
      nodePort: 30123 # 각 클러스터 노드의 포트 30123으로 서비스에 액세스 할 수 있다.
    selector:
        app: kubi
```

### 외부 로드밸런서로 서비스 노출
노드포트 대신 서비스 타입을 로드밸런서로 설정하기만 하면 된다. 로드밸런서의 IP 주소로 서비스에 액세스 할 수 있다.<br>
로드밸런서를 지원하지 않는 환경에서도 여전히 노드포트 서비스처럼 작동한다. 로드밸런서는 노드포트 서비스의 확장이기 때문이다.

### 외부 연결의 특성 이해

**불필요한 네트워크 홉의 이해와 예방**<br>
외부 클라이언트가 노드포트로 서비스에 접속할 경우 임의로 선택된 파드가 동일 노드에서 실행중일 수도 있고 그렇지 않을 수도 있다. 파드에 도달하려면 추가적인 네트워크 홉이 필요할 수 있으며 이것이 항상 바람직한 것은 아니다.
```YAML
spec:
    externalTrafficPolicy: Local # 스펙을 통해 수신 노드에 실행중인 파드로만 트래픽을 전달 할 수 있다.
```
하지만 해당 노드에 파드가 실행중이지 않으면 연결이 중단된다.

## 인그레스 리소스로 서비스 외부 노출
인그레스는 한 IP 주소로 수십 개의 서비스에 접근이 가능하도록 지원해준다. 클라이언트가 HTTP 요청을 인그레스에 보낼 때, 요청한 호스트와 경로에 따라 요청을 전달할 서비스가 결정된다.<br>
인그레스 오브젝트가 제공하는 기능을 살펴보기 전에 인그레스 리소스를 작동시키려면 클러스터에 인그레스 컨트롤러를 실행해야 한다.

### 인그레스 리소스 생성
```YAML
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
    name: kubia
spec:
    rules:
    - host: kubia.example.com # 인그레스는 kubia.example.com 도메인 이름을 서비스에 매핑한다.
      http:
      paths:
      - path: /
        backend:
            serviceName: kubia-nodeport
            servicePort: 80
```

### 인그레스로 서비스 액세스
서비스에 액세스  하려면 도메인 이름이 인그레스 컨트롤러의 IP와 매핑되도록 확인해야 한다.
- 인그레스의 IP 주소 얻기 : kubectl get ingresses
- 인그레스 컨트롤러가 구성된 호스트의 IP를 인그레스 엔드포인트로 지정 
- 인그레스 파드로 액세스

### 하나의 인그레스로 여러 서비스 노출
인그레스 스펙을 자세히 보면 규칙과 경로가 모두 배열이므로 여러 항목을 가질 수 있다.
- 동일한 호스트의 다른 경로로 여러 서비스 매핑
```YAML
http:
paths:
- path: /
  backend:
    serviceName: kubia-nodeport
    servicePort: 80
- path: /bar
  backend:
    serviceName: bar
    servicePort: 80
```

서로 다른 호스트로 서로 다른 서비스 매핑도 가능 하다.

### TLS 트래픽을 처리하도록 인그레스 수정
인증서와 개인 키를 시크릿으로 만들어 인그레스에 첨부 해야 한다.

## 파드가 연결을 수락할 준비가 됐을 때 신호 보내기

### 레디니스 프로브 소개
라이브니스 프로브와 비슷하게 레디니스 프로브를 정의할 수 있다.<br>
레디니스 프로브는 주기적으로 호출되며 특정 파드가 클라이언트 요청을 수신할 수 있는지를 결정 한다.
- 프로세스를 실행하는 Exec 프로브
- HTTP GET 프로브
- TCP 소켓 프로브
의 세 종류가 있다.

<br>
레디니스 프로브는 라이브니스 프로브와 다르게 실패하더라도 컨테이너가 종료되거나 다시 시작되지 않는다.